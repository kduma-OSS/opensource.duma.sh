---
navigation:
  title: CloudFlare Worker

title: Private Satis Repository CloudFlare Worker
description: Worker that allows you to host your own private Composer repository directly from a CloudFlare R2 Storage bucket.

list_title: Private Satis Repository CloudFlare Worker
type: app
platform: CloudFlare Worker
active: true
github: https://github.com/kduma-OSS/CFW-serverless-satis-worker
system: Serverless Satis
system_url: /systems/serverless-satis
---

This is a [CloudFlare Worker](https://workers.cloudflare.com/){:target="_blank"} that allows you to host your own 
private Composer repository directly from a [CloudFlare R2 Storage bucket](https://developers.cloudflare.com/r2/){:target="_blank"},
without the need to run any servers. Authentication is done using usernames and passwords stored in [CloudFlare KV](https://developers.cloudflare.com/kv/){:target="_blank"}.

::u-button-group
:u-button[GitHub Repository]{icon="bxl:github" href="https://github.com/kduma-OSS/CFW-serverless-satis-worker" target="_blank"}

:u-button[Releases]{icon="material-symbols:cloud-download" href="https://github.com/kduma-OSS/CFW-serverless-satis-worker/releases/latest/" target="_blank"}
::

## Deployment

To deploy this worker, you need to clone repository, update `wrangler.toml` configuration file and run `wrangler deploy` command.

```bash
git clone git@github.com:kduma-OSS/CFW-serverless-satis-worker.git
cd CFW-serverless-satis-worker
npm install

# Update wrangler.toml file

npm run deploy
```

## Worker Configuration

You need to update `wrangler.toml` file with your own values:

| Variable Name                        | Description                                                                       |
|--------------------------------------|-----------------------------------------------------------------------------------|
| `name`                               | Name of your CloudFlare Worker                                                    |
| `vars.PUBLIC_ACCESS_TO_INDEX`        | If true, index page will be accessible without authentication                     |
| `vars.PUBLIC_ACCESS_TO_JSON`         | If true, JSON indexes will be accessible without authentication                   |
| `vars.CHECK_FILE_RESTRICTIONS`       | See [Selective Access](#selective-access)                                         |
| `vars.CHECK_EXTRA_JSON_RESTRICTIONS` | See [Selective Access](#selective-access)                                         |
| `vars.STORE_PASSWORDS_HASHED`        | See [Authentication](#authentication)                                             |
| `vars.ENABLE_USER_ENDPOINT`          | See [User Endpoint](#user-endpoint)                                               |
| `routes.pattern`                     | Domain you want to expose your private repository on (need to use CloudFlare DNS) |
| `kv_namespaces.id`                   | Namespace ID of your Worker KV to read users from                                 |
| `r2_buckets.bucket_name`             | Name of private bucket where are stored files generated by `s3-satis` tool        |

```toml
name = "<name>"
main = "src/index.ts"
compatibility_date = "2023-12-06"

[vars]
PUBLIC_ACCESS_TO_INDEX = false
PUBLIC_ACCESS_TO_JSON = false
CHECK_FILE_RESTRICTIONS = false
CHECK_EXTRA_JSON_RESTRICTIONS = false
STORE_PASSWORDS_HASHED = false
ENABLE_USER_ENDPOINT = false

[[routes]]
pattern = "<domain>"
custom_domain = true

[[kv_namespaces]]
binding = "AUTH"
id = "<kv_id>"

[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "<bucket_name>"
```

## Authentication

Authentication is done using usernames and passwords stored in [CloudFlare KV](https://developers.cloudflare.com/kv/){:target="_blank"}.
You need to create a KV namespace and bind it to `AUTH` variable in `wrangler.toml` file.
Worker will read usernames and passwords from KV namespace and use them to authenticate users.

When adding new users to KV, please set username as a key and password as a value.
If `STORE_PASSWORDS_HASHED` is set to `true`, you need to hash passwords with SHA-256 before adding them to KV.
If `STORE_PASSWORDS_HASHED` is set to `false`, passwords are stored in plain text.

### User Endpoint

When `ENABLE_USER_ENDPOINT` is set to `true`, you can use `https://<domain>/user.json` endpoint to check logged-in user, 
and get list of assigned permissions (for more details see [Selective Access](#selective-access))

## Selective Access

If you want to restrict users to access only specific packages or version, you can use 
[`file-restrictions-map-generator` extension of `s3-satis` tool](/systems/serverless-satis/s3-satis#file-restrictions-map-generator-extension-file-restrictions-map-generator),
to generate a map of file packages and versions. 
Then, you need to set `vars.CHECK_FILE_RESTRICTIONS` to `true` and deploy the Worker.

After doing that, you can edit your user in KV. To specify which packages and versions are accessible to user, edit value field,
add a new line after users password and list tags (delimited by a comma) of packages and versions you want to allow access to.

For example:

```text
password 
vendor/package-1:1.x,vendor/package-2:2.0.0.0,vendor/package-3:dev-master
```

If user tries to access a package or version that is not listed in KV, the request will be rejected with `403 Forbidden` error.

If you want to remove packages to which user doesn't have access from json files (so the composer won't complain about not having access to them when upgrading),
you cen enable [`extra-json` option in `file-restrictions-map-generator` extension of `s3-satis` tool](/systems/serverless-satis/s3-satis#file-restrictions-map-generator-extension-file-restrictions-map-generator),
and set `vars.CHECK_EXTRA_JSON_RESTRICTIONS` to `true`.