<template>
<!--  <textarea rows="25" style="width: 100%">{{ deprecated }}</textarea>-->
  <template v-if="noPlatforms">
    <ProseUl>
      <ProseLi v-for="item in active">
        <template v-if="item.path">
          <ProseA :href="item.path">
            {{ item.title }}
          </ProseA>
        </template>
        <template v-else>
          {{ item.title }}
        </template>
        <template v-if="item.platform">
          &nbsp;
          <UBadge>{{ item.platform }}</UBadge>
        </template>
        <template v-for="platform in item.platforms">
          &nbsp;
          <UBadge>{{ platform }}</UBadge>
        </template>
        <template v-if="item.github">
          &nbsp;
          <a :href="item.github" target="_blank">
            <Icon name="bxl:github"/>
          </a>
        </template>
        <template v-if="item.featured">
          &nbsp;
          <Icon name="ic:outline-star-border"/>
        </template>
        <template v-if="item.system">
          &nbsp;
          <template v-if="item.system_url">
            (part of <ProseA :href="item.system_url" v-if="item.system_url">{{ item.system }}</ProseA>)
          </template>
          <template v-else>
            (part of {{ item.system }})
          </template>
        </template>
      </ProseLi>
    </ProseUl>
  </template>
  <template v-else>
    <ProseUl>
      <ProseLi v-for="(items, platform) in active">
        Platform
        &nbsp;
        <UBadge>{{ platform }}</UBadge>
        <ProseUl>
          <ProseLi v-for="item in items">
            <template v-if="item.path">
              <ProseA :href="item.path">
                {{ item.title }}
              </ProseA>
            </template>
            <template v-else>
              {{ item.title }}
            </template>
            <template v-for="platform in item.platforms">
              &nbsp;
              <UBadge>{{ platform }}</UBadge>
            </template>
            <template v-if="item.github">
              &nbsp;
              <a :href="item.github" target="_blank">
                <Icon name="bxl:github"/>
              </a>
            </template>
            <template v-if="item.featured">
              &nbsp;
              <Icon name="ic:outline-star-border"/>
            </template>
            <template v-if="item.system">
              &nbsp;
              <template v-if="item.system_url">
                (part of <ProseA :href="item.system_url" v-if="item.system_url">{{ item.system }}</ProseA>)
              </template>
              <template v-else>
                (part of {{ item.system }})
              </template>
            </template>
          </ProseLi>
        </ProseUl>
      </ProseLi>
    </ProseUl>
  </template>
  <template v-if="deprecated.length">
    <ProseH2 id="deprecated">Deprecated</ProseH2>
    <ProseUl>
      <ProseLi v-for="item in deprecated">
        <template v-if="item.path">
          <ProseA :href="item.path">
            {{ item.title }}
          </ProseA>
        </template>
        <template v-else>
          {{ item.title }}
        </template>
        &nbsp;
        <UBadge type="danger">{{ item.platform }}</UBadge>
        <template v-for="platform in item.platforms">
          &nbsp;
          <UBadge type="danger">{{ platform }}</UBadge>
        </template>
        <template v-if="item.github">
          &nbsp;
          <a :href="item.github" target="_blank">
            <Icon name="bxl:github"/>
          </a>
        </template>
        <template v-if="item.featured">
          &nbsp;
          <Icon name="ic:outline-star-border"/>
        </template>
      </ProseLi>
    </ProseUl>
  </template>
</template>

<script>

import {collect} from "collect.js";
import explode from "locutus/php/strings/explode";
import array_slice from "locutus/php/array/array_slice";

export default {
  name: "ProjectsList",
  props: {
    type: {
      type: String,
      default: 'app'
    },
    noPlatforms: {
      type: Boolean,
      default: false
    },
  },
  async setup(props) {
    let items, list, unified;
    [items, list] = await Promise.all([
      queryCollection('docs')
          .where('type', '=', props.type)
          .order('active', 'DESC')
          .order('title', 'ASC')
          .select('path', 'id', 'title', 'description', 'type', 'platform', 'active', 'github', 'featured', 'list_title', 'system', 'system_url')
          .all(),

      queryCollection('data')
          .where('type', '=', props.type)
          .order('active', 'DESC')
          .order('title', 'ASC')
          .select('id', 'title', 'description', 'type', 'platform', 'active', 'github', 'featured', 'list_title', 'system', 'system_url')
          .all(),
    ]);

    list = collect(list ?? [])
      .map((row) => {
        row._type = 'list'
        return row;
      });

    items = collect(items ?? [])
      .map((row) => {
        row._type = 'file'
        return row;
      });

    unified = collect([list, items])
      .flatten(1)
      .map((row) => {
        if(row.list_title)
          row.title = row.list_title;

        row.platforms = explode(' & ', row.platform);
        row.platform = row.platforms[0]
        row.platforms = array_slice(row.platforms, 1)

        return row;
      })
      .sortBy('title')
      .groupBy((item, key) => (item.active === '1' || item.active === true || item.active === undefined) ? 'active' : 'deprecated');

    let active = unified.get('active', collect());
    if(props.noPlatforms) {
      active = active.all();
    } else {
      active = active.groupBy('platform').sortKeysDesc().all();
    }
    let deprecated = unified.get('deprecated', collect()).all();

    return {
      active, deprecated
    }
  }
};
</script>
